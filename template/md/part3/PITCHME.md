@title[一种可能的替代-KCP协议]

## @color[black](一种可能的替代-KCP协议)

@fa[arrow-down text-black]

+++?
### KCP是什么

+++?

"KCP是一个快速可靠协议，能以比 TCP浪费10%-20%的带宽的代价，换取平均延迟降低 30%-40%，且最大延迟降低三倍的传输效果"

+++?

"TCP信道是一条流速很慢，但每秒流量很大的大运河，而KCP是水流湍急的小激流"

+++?
测试场景
- 用netty实现基于kcp的echo-server和echo-client
- 使用kcp极速模式
- 尽量保证请求和响应贴近传输时间
- 观察当时发送时的带宽

+++?

![](https://s2.ax1x.com/2020/01/17/1SC2eU.png)

+++?

### KCP解决了发送缓冲区满的问题了吗?

+++?

严格来说，KCP并没有解决这个问题，它内部也维护了一个以ack驱动的发送缓冲区，一样会面临TCP在长肥网络下发送缓冲区满的问题

+++?
## KCP解决了拥塞控制窗口收敛慢的问题吗？

+++?

在极速模式下，KCP并没有任何拥塞控制算法，自然不会面临这种问题，测试看到的增长大部分也是因为这个因素贡献的；但是在其他模式下，KCP还会收到拥塞控制算法的影响，还是ACK驱动拥塞控制窗口的增长，所以还是会有TCP的问题

+++?

### KCP解决了滑动窗口移动慢的问题吗？

+++?
不幸的是，KCP也没有解决这个问题，它的滑动窗口依然是靠ACK驱动的

+++?

### KCP解决了头部阻塞的问题吗？

+++?
答案还是不，在连接层面，KCP不想quic有额外的标志来表示一个请求，所以头部阻塞还会存在

+++?
### 那KCP带来了什么
+++?
KCP带来的主要的改进是更加激进的重传策略，对比起TCP的指数退让式增大超时重传时间，还有收到三个dup-ack之后再开始重传，KCP的会采用1个或者0.5个rto这样步进策略来重传没有确认的segment，并且在极速模式下，收到一次dup-ack的情况下就开始重传，最大限度的保证了请求的最坏延时优于TCP，这种这么激进的重传策略但是这种这么激进的策略，会导致了更多原来没有需要重传的segment被再次发送，浪费了带宽

+++?

这么激进的重传策略也能在丢包比较频繁的场景下面，提升窗口移动的速度，缓存空间释放速度

+++?

此外，kcp还能放进诸如前向纠错这样的特性，进一步优化长距离网络下面丢包的影响

